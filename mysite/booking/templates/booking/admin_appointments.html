{% extends "booking/admin_base.html" %}

{% block content %}
<h3 class="fw-bold mb-3">All Appointments</h3>

<form class="row g-2 mb-3" method="get">
  <div class="col-md-3">
    <input class="form-control"
           name="q"
           placeholder="Search patient, doctor, hospital"
           value="{{ q }}">
  </div>

  <div class="col-md-2">
    <select class="form-select" name="status">
      <option value="">All Status</option>
      <option value="Pending"  {% if status == "Pending" %}selected{% endif %}>Pending</option>
      <option value="Approved" {% if status == "Approved" %}selected{% endif %}>Approved</option>
      <option value="Cancelled" {% if status == "Cancelled" %}selected{% endif %}>Cancelled</option>
    </select>
  </div>

  <div class="col-md-2">
    <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
  </div>
  <div class="col-md-2">
    <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
  </div>

  <div class="col-md-3 d-flex gap-2">
    <button class="btn btn-primary flex-grow-1">Filter</button>
    <a class="btn btn-outline-secondary" href=".">Reset</a>
  </div>
</form>

<form method="get" action="{% url 'admin_export_appointments_csv' %}" class="mb-3">
  <!-- Preserve current filters when exporting -->
  <input type="hidden" name="q" value="{{ q }}">
  <input type="hidden" name="status" value="{{ status }}">
  <input type="hidden" name="start_date" value="{{ start_date }}">
  <input type="hidden" name="end_date" value="{{ end_date }}">
  <button class="btn btn-outline-secondary btn-sm">Export CSV</button>
</form>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Appt Code</th>
        <th>Patient</th>
        <th>Doctor</th>
        <th>Department</th>
        <th>Hospital</th>
        <th>Date</th>
        <th>Time</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
    {% for an in appointments %}
      <tr>
        <td>{{ a.id }}</td>
        <td>{{ a.code }}</td>
        <td>{{ a.patient.user.get_full_name }}</td>
        <td>Dr. {{ a.doctor.user.get_full_name }}</td>
        <td>{{ a.doctor.specialization }}</td>
        <td>{{ a.doctor.hospital }}</td>
        <td>{{ a.date|date:"M j, Y" }}</td>
        <td>{{ a.time|time:"g:i a" }}</td>
        <td>
          <span class="badge
            {% if a.status == 'Approved' %}bg-success
            {% elif a.status == 'Cancelled' %}bg-danger
            {% else %}bg-warning text-dark{% endif %}">
            {{ a.status }}
          </span>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="9" class="text-muted">No appointments found.</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}