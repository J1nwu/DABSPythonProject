{% extends "booking/admin_base.html" %}
{% block title %}Manage Patients â€“ DABS{% endblock %}

{% block content %}
<h3 class="fw-bold mb-3">Manage Patients</h3>

<form class="row g-2 mb-3" method="get">
  <div class="col-md-4">
    <input class="form-control"
           name="q"
           placeholder="Search patient by name, email, username"
           value="{{ q }}">
  </div>
  <div class="col-md-3">
    <button class="btn btn-primary">Filter</button>
    <a class="btn btn-outline-secondary ms-1" href="{% url 'admin_patients' %}">Reset</a>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Patient</th>
        <th>Username</th>
        <th>Email</th>
        <th>Total Appointments</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for p in patients %}
      <tr>
        <td>{{ p.id }}</td>

        <td>
          {% if p.get_full_name %}
            {{ p.get_full_name }}
          {% else %}
            {{ p.username }}
          {% endif %}
        </td>

        <td>{{ p.username }}</td>
        <td>{{ p.email }}</td>

        {# Appointment. Patient is FK to User, so reverse name is appointment_set #}
        <td>{{ p.appointment_set.count }}</td>

        <td>
          <span class="badge bg-{% if p.is_active %}success{% else %}secondary{% endif %}">
            {% if p.is_active %}Active{% else %}Inactive{% endif %}
          </span>
        </td>

        <td>
          <form method="post" action="" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="patient_id" value="{{ p.id }}">
            <input type="hidden" name="action" value="activate">
            <button class="btn btn-sm btn-outline-success">Activate</button>
          </form>

          <form method="post" action="" class="d-inline ms-1">
            {% csrf_token %}
            <input type="hidden" name="patient_id" value="{{ p.id }}">
            <input type="hidden" name="action" value="deactivate">
            <button class="btn btn-sm btn-outline-secondary">Deactivate</button>
          </form>

          <form method="post" action="" class="d-inline ms-1"
                onsubmit="return confirm('Delete this patient and their appointments?');">
            {% csrf_token %}
            <input type="hidden" name="patient_id" value="{{ p.id }}">
            <input type="hidden" name="action" value="delete">
            <button class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="7" class="text-muted">No patients found.</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}