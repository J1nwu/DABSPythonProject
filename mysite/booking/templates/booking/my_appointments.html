{% extends "booking/patient_base.html" %}

{% block title %}My Appointments â€“ DABS{% endblock %}

{% block content %}
<h3 class="fw-bold mb-3">My Appointments</h3>

{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags }} mb-2">{{ m }}</div>
  {% endfor %}
{% endif %}

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>Appt ID</th>
        <th>Doctor</th>
        <th>Department</th>
        <th>Hospital</th>
        <th>Date</th>
        <th>Time</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for a in appts %}
      <tr>
        <td>A-10{{ a.id }}</td>
        <td>Dr. {{ a.doctor.user.first_name }} {{ a.doctor.user.last_name }}</td>
        <td>{{ a.department }}</td>
        <td>{{ a.hospital }}</td>
        <td>{{ a.date }}</td>
        <td>{{ a.time }}</td>
        <td>
          <span class="badge text-bg-secondary">{{ a.status }}</span>
        </td>
       <td class="d-flex gap-2">

  <!-- Reschedule -->
  <a class="btn btn-sm btn-outline-primary"
     href="{% url 'reschedule_appointment' a.id %}">
    Reschedule
  </a>

  <!-- Cancel -->
  <form method="post"
        action="{% url 'cancel_appointment' a.id %}"
        onsubmit="return confirm('Cancel this appointment?');">
    {% csrf_token %}
    <button class="btn btn-sm btn-outline-danger" type="submit"
      {% if a.status == 'Cancelled' or a.status == 'Completed' %}disabled{% endif %}>
      Cancel
    </button>
  </form>

  <!-- Feedback -->
  {% if a.status == 'Completed' and not a.feedback %}
    <a class="btn btn-sm btn-outline-success"
       href="/dashboard/patient/appointments/{{ a.id }}/feedback/">
      Give Feedback
    </a>
  {% endif %}

  <!-- If feedback already submitted, show a label -->
  {% if a.status == 'Completed' and a.feedback %}
    <span class="badge bg-success align-self-center">Feedback Submitted</span>
  {% endif %}

</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="8" class="text-muted">No appointments yet.</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<a class="btn btn-outline-primary" href="{% url 'find_doctor' %}">
  Find Doctor
</a>
{% endblock %}
